# PentestCyprus 3.0 | urg3nt_c4ll

**Category:** Forensics **Difficulty:** Hard

**Description:** There is some hidden communication in TCP packets that points to the FBI. 

## Solution

The pcap file contains a tcp connection between two hosts. By right clicking and following the tcp stream we see a strange communication that does not give us much.

![Tcp Stream](https://github.com/Sikkis/ctf-writeups/2017/urg3nt_call/images/tcp-stream.png)

After some time I noticed that some packages had an error message saying that the urgent pointer field is nonzero while the URG flag is not set. When we inspect the TCP header structure we can see that the Urgent Pointer has a length of 2 bytes, when the Urgent flag is set to 0.

```
    0                   1                   2                   3   
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |          Source Port          |       Destination Port        |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                        Sequence Number                        |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                    Acknowledgment Number                      |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |  Data |           |U|A|P|R|S|F|                               |
   | Offset| Reserved  |R|C|S|S|Y|I|            Window             |
   |       |           |G|K|H|T|N|N|                               |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |           Checksum            |         Urgent Pointer        |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                    Options                    |    Padding    |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                             data                              |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

                            TCP Header Format

          Note that one tick mark represents one bit position.
```
We can see all the malformed packages by selecting the Analyse->Expert Information.
Each second byte of the Urgent Pointer is not set to zero, and falls to the range of the ASCII characters and the first one is the character "p". If we scroll in each of the 28 malformed packages we can reconstruct the flag!

![Tcp Stream](https://github.com/Sikkis/ctf-writeups/2017/urg3nt_call/images/expert-information.png)

pency_3{h1d3_in_pl41n_s1ght}

## Extra 

A big thanks to Marios and Simon from RunSec for suggesting to use tshark to extract the urgent pointers!
```
for i in `tshark -r urg3nt_c4ll.pcap -T fields -e tcp.urgent_pointer`; do echo $(printf \\$(printf '%03o' $i)); done
    
p   
e   
n   
c   
y   
_   
3   
{   
h   
1   
d   
3   
_   
i   
n   
_   
p   
l   
4   
1   
n   
_   
s   
1   
g   
h   
t   
}   
```
